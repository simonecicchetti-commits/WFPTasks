# WFP Projects - Session Documentation
## Date: 2026-01-14 | Session: 01

---

# EXECUTIVE SUMMARY

This session focused on WFP (World Food Programme) infrastructure monitoring and tooling. Main achievements:
1. Fixed critical bugs in RBP_IDB repository (hazard_pipe.py)
2. Created db_explorer.py script for database health monitoring
3. Set up WFPTasks GitHub repository for personal tools
4. Created Streamlit dashboard for visual database monitoring

---

# PROJECTS OVERVIEW

## 1. RBP_IDB (Regional Bureau Panama - Intelligence Dashboard Backend)

**Repository:** https://github.com/wfp-rbp/RBP_IDB
**Local Path:** `/Users/simonecicchetti/WFP-Projects/RBP_IDB`
**Technology:** Python, FastAPI, MySQL
**Deployment:** OpenShift (WFP infrastructure)

### Branches:
- `master` - Production
- `uat` - Development/Testing (corresponds to OpenShift dev environment)

### Architecture:
```
RBP_IDB/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ fetcher/          # Data ingestion from external APIs
â”‚   â”‚   â””â”€â”€ src/domain/pipes/
â”‚   â”‚       â”œâ”€â”€ hazard_pipe.py      # ADAM API (earthquakes, floods, cyclones)
â”‚   â”‚       â”œâ”€â”€ conflict_pipe.py    # ACLED conflict data
â”‚   â”‚       â”œâ”€â”€ economic_pipe.py    # Food inflation, currency
â”‚   â”‚       â””â”€â”€ ...
â”‚   â””â”€â”€ trigger/          # Alert generation system
â”œâ”€â”€ src/                  # Main FastAPI application
â””â”€â”€ Dockerfile
```

### Database:
- **AWS RDS MySQL** (eu-west-1)
- **Dev:** rdp-idb-dev.chsu4ma0ibqc.eu-west-1.rds.amazonaws.com
- **Prod:** rbp-idb-prod.cxai6uauo3yn.eu-west-1.rds.amazonaws.com
- **Requires VPN** to connect

### Key Tables (schema: idb):
- `RBP_fcs`, `RBP_rcsi` - Food security indicators
- `RBP_ACLED_conflict` - Conflict data
- `RBP_ADAM_earthquake`, `RBP_ADAM_flood`, `RBP_ADAM_cyclon` - Natural hazards
- `RBP_trigger_result` - Trigger system output
- `RBP_adm0_mapping` - Country configuration (enabled countries)

### Bug Fixed This Session:
**File:** `modules/fetcher/src/domain/pipes/hazard_pipe.py`
**Branch:** `uat`
**Commit:** `612fa70`

Copy-paste bugs in exception handlers were logging wrong table names:
- Line 97: `db.flood_table` â†’ `db.earthquake_table`
- Line 98: `"floods were NOT updated"` â†’ `"earthquakes were NOT updated"`
- Line 132: REMOVED (was incorrectly appending failure in success block)
- Line 135: `db.flood_table` â†’ `db.cyclone_table`
- Line 136: `"floods were NOT updated"` â†’ `"cyclones were NOT updated"`

**Status:** Fixed and deployed. Verified working via OpenShift logs.

### Known Issues:
- ADAM API returning DNS resolution errors (infrastructure issue, not code)
- BLZ and ECU are enabled countries but never triggered (need investigation)

---

## 2. WFPTasks (Personal Tools Repository)

**Repository:** https://github.com/simonecicchetti-commits/WFPTasks
**Local Path:** `/Users/simonecicchetti/WFP-Projects/WFPTasks`
**Purpose:** Personal utility scripts for WFP project monitoring

### Structure:
```
WFPTasks/
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ app.py              # Streamlit dashboard (560 lines)
â”‚   â””â”€â”€ requirements.txt    # Dependencies
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ db_explorer.py      # Database health monitoring (760 lines)
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ SESSION_2026_01_14_01.md  # This file
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

### db_explorer.py (v1.6)
Database health monitoring CLI tool.

**Features:**
- Connects to dev/prod MySQL databases
- Scans all key tables for data freshness
- Analyzes trigger execution by country
- Verifies SQL views
- Exports results to JSON
- Color-coded status indicators

**Usage:**
```bash
python3 scripts/db_explorer.py dev   # Development
python3 scripts/db_explorer.py prod  # Production
```

**Credentials (hardcoded in script):**
- Dev: user=dev, password=2024devHelloWorld.
- Prod: user=prod, password=2024panamaIDB!

### Streamlit Dashboard (app.py)
Web interface for db_explorer.

**Features:**
- Environment selector (dev/prod)
- Run Analysis button with spinner
- Color-coded status tables
- Trigger status by country
- SQL views verification
- Export to JSON/Excel

**Launch:**
```bash
cd /Users/simonecicchetti/WFP-Projects/WFPTasks
streamlit run dashboard/app.py
# Opens browser at http://localhost:8501
```

**Requirements:** VPN must be connected before running.

**Dependencies:**
- streamlit>=1.29.0
- pandas>=2.0.0
- pymysql>=1.1.0
- openpyxl>=3.1.0
- plotly>=5.18.0
- reportlab>=4.0.0

---

## 3. CARICOM Platform

**Repository:** https://github.com/wfp-rbp/CARICOM_platform
**Local Path:** `/Users/simonecicchetti/WFP-Projects/CARICOM_platform`
**Technology:** Python, Dash (Plotly), MySQL
**Purpose:** Caribbean food security visualization dashboard

### Key Info:
- Uses same MySQL database as IDB (schemas: rtm_analytics, caricom_other_data)
- External API: GDACS for natural hazards
- Deployment: OpenShift (caricom-platform-dev)
- Port: 8080

### Onboarding Documentation:
Full analysis in `/Users/simonecicchetti/WFP-Projects/CARICOM_ONBOARDING_ANSWERS.md`

---

## 4. IDB Onboarding (Inter-American Development Bank)

**Context:** WFP is onboarding the Food Security Crisis Observatory to IDBCloud4LAC
**Onboarding Form:** `/tmp/onboarding_idb.txt`
**Status:** Form template received, needs to be filled with technical details

---

# FIXES APPLIED THIS SESSION

## 1. hazard_pipe.py Bug Fix (RBP_IDB)
See above for details.

## 2. db_explorer.py Path Fix (WFPTasks)
**Problem:** Hardcoded path exposed username
```python
# OLD (line 502):
filename = f"/Users/simonecicchetti/WFP-Projects/db_exploration_{env}_{timestamp}.json"

# NEW:
script_dir = os.path.dirname(os.path.abspath(__file__))
filename = os.path.join(script_dir, f"db_exploration_{env}_{timestamp}.json")
```
**Also added:** `import os` at line 28

## 3. WFPTasks Repository Cleanup
- Removed old Haiti HTML files
- Added scripts/ directory structure
- Added dashboard/ with Streamlit app

---

# PENDING TASKS

1. **Test Streamlit Dashboard**
   - Need VPN connected
   - Run: `streamlit run dashboard/app.py`
   - Verify all features work

2. **Add PDF Export to Dashboard**
   - Button exists but disabled
   - Need to implement with reportlab

3. **Investigate BLZ/ECU Countries**
   - Enabled in database but never triggered
   - Need to check why

4. **Future: Google Cloud Migration**
   - Discussed replicating entire system on Google Cloud
   - Would eliminate VPN requirement
   - Estimated cost: ~$20/month
   - Architecture planned but not implemented

---

# GITHUB TOKENS & CREDENTIALS

**WFPTasks repo push token:**
- Token was used (revoke it after this session)
- Stored in: GitHub Settings â†’ Developer settings â†’ Personal access tokens

**Database credentials:**
- Stored in db_explorer.py (lines 34-47)
- Same credentials used by RBP_IDB

---

# COMMIT HISTORY THIS SESSION

## RBP_IDB (uat branch)
```
612fa70 - Fix copy-paste bugs in hazard_pipe.py exception handlers
```

## WFPTasks (main branch)
```
6606ff7 - Add Streamlit monitoring dashboard
c43df25 - Restructure repository for WFP monitoring tools
```

---

# USER PREFERENCES

- **Author for commits:** "Simone Cicchetti" (no email)
- **No AI/Claude mentions** in code, commits, or documentation
- **Language:** Italian for conversation, English for code/docs
- **Approach:** Always verify 100% before making changes

---

# FILE PATHS REFERENCE

| File | Path |
|------|------|
| db_explorer.py (repo) | `/Users/simonecicchetti/WFP-Projects/WFPTasks/scripts/db_explorer.py` |
| db_explorer.py (original) | `/Users/simonecicchetti/WFP-Projects/db_explorer.py` |
| Dashboard app | `/Users/simonecicchetti/WFP-Projects/WFPTasks/dashboard/app.py` |
| hazard_pipe.py | `/Users/simonecicchetti/WFP-Projects/RBP_IDB/modules/fetcher/src/domain/pipes/hazard_pipe.py` |
| CARICOM app | `/Users/simonecicchetti/WFP-Projects/CARICOM_platform/app.py` |
| CARICOM onboarding | `/Users/simonecicchetti/WFP-Projects/CARICOM_ONBOARDING_ANSWERS.md` |
| IDB onboarding form | `/tmp/onboarding_idb.txt` |
| This doc | `/Users/simonecicchetti/WFP-Projects/WFPTasks/docs/SESSION_2026_01_14_01.md` |

**Note:** db_explorer.py exists in two places - the original in WFP-Projects and a copy in WFPTasks/scripts/. Both have the path fix applied.

---

# NEXT SESSION CHECKLIST

1. [ ] Connect to VPN
2. [ ] Test Streamlit dashboard: `streamlit run dashboard/app.py`
3. [ ] Verify dashboard connects to database
4. [ ] Test all features (refresh, tables, export)
5. [ ] Consider PDF export implementation
6. [ ] Investigate BLZ/ECU trigger issue

---

# TECHNICAL NOTES

## VPN Requirement
The WFP MySQL databases are in a private AWS VPC. Connection requires:
- WFP VPN active
- IP must be in allowed security group

## OpenShift
- WFP uses OpenShift for container deployments
- CronJobs run fetchers on schedule
- Dev environment corresponds to `uat` git branch

## Status Color Codes
| Emoji | Status | Days Old |
|-------|--------|----------|
| ğŸŸ¢ | Current | 0-7 |
| ğŸŸ¡ | Recent | 8-30 |
| ğŸŸ  | Outdated | 31-90 |
| ğŸ”´ | Stale | 91-365 |
| â›” | Critical | >365 |
| âŒ | Error | - |
| âšª | N/A | - |

## ADAM API Issue
The ADAM API (hazards) is returning DNS resolution errors:
```
Error: HTTPSConnectionPool host='x8qclqysv7.execute-api.eu-west-1.amazonaws.com'
Max retries exceeded - Name or service not known
```
This is an **infrastructure issue**, not a code bug. The API endpoint might be down or DNS is failing from within OpenShift.

## Enabled Countries (from RBP_adm0_mapping)
Countries with `enabled=1` in the database:
- HTI (Haiti), GTM (Guatemala), SLV (El Salvador), HND (Honduras), NIC (Nicaragua)
- COL (Colombia), VEN (Venezuela), ECU (Ecuador), PER (Peru), BOL (Bolivia)
- BLZ (Belize), PAN (Panama), DOM (Dominican Republic), CUB (Cuba)
- JAM (Jamaica), and others...

**Issue:** BLZ and ECU show as enabled but have never triggered (0 entries in RBP_trigger_result)

---

# DISCUSSION: FUTURE GOOGLE CLOUD ARCHITECTURE

User expressed interest in replicating the entire system on Google Cloud to eliminate VPN dependency.

**Proposed architecture:**
```
Google Cloud:
â”œâ”€â”€ Cloud SQL (MySQL)      - Database replica
â”œâ”€â”€ Cloud Run              - Fetchers (serverless)
â”œâ”€â”€ Cloud Scheduler        - CronJobs
â””â”€â”€ Cloud Run              - API + Dashboard

External APIs (same as current):
â”œâ”€â”€ ADAM API              - Public, no auth
â”œâ”€â”€ ACLED                 - Needs API key
â”œâ”€â”€ HungerMap             - Public
â”œâ”€â”€ PDC                   - Needs WFP credentials
â””â”€â”€ World Bank/FAO        - Public
```

**Estimated cost:** ~$20/month
**Status:** Discussed but not implemented. Start with local dashboard first.

---

*Document generated: 2026-01-14 12:45*
*Updated: 2026-01-14 12:50*
*For next Claude session: Read this file first to restore full context*
